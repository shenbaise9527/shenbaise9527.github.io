<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Golang与C语言相互调用 - 深白色9527</title><meta name="Description" content="深白色9527"><meta property="og:title" content="Golang与C语言相互调用" />
<meta property="og:description" content="主要是描述Go语言调用易盛行情API的动态库过程中，一些需要注意的地方。 类型对应关系 C类型 调用方法 Go类型 字节数 char C.char byte 1 signed char C.schar int8 1 unsigned char C.uchar uint8 1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shenbaise9527.com/2021/07/24/golang-c-call/" /><meta property="og:image" content="https://shenbaise9527.com/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-24T21:56:42+08:00" />
<meta property="article:modified_time" content="2021-07-24T21:56:42+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shenbaise9527.com/logo.png"/>

<meta name="twitter:title" content="Golang与C语言相互调用"/>
<meta name="twitter:description" content="主要是描述Go语言调用易盛行情API的动态库过程中，一些需要注意的地方。 类型对应关系 C类型 调用方法 Go类型 字节数 char C.char byte 1 signed char C.schar int8 1 unsigned char C.uchar uint8 1"/>
<meta name="application-name" content="深白色9527">
<meta name="apple-mobile-web-app-title" content="深白色9527"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shenbaise9527.com/2021/07/24/golang-c-call/" /><link rel="prev" href="https://shenbaise9527.com/2021/07/24/golang-string/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Golang与C语言相互调用",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/shenbaise9527.com\/2021\/07\/24\/golang-c-call\/"
        },"image": ["https:\/\/shenbaise9527.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go, cgo","wordcount":  2932 ,
        "url": "https:\/\/shenbaise9527.com\/2021\/07\/24\/golang-c-call\/","datePublished": "2021-07-24T21:56:42+08:00","dateModified": "2021-07-24T21:56:42+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/shenbaise9527.com\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "深白色"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="深白色9527"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>深白色9527</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/shenbaise9527" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="深白色9527"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>深白色9527</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/shenbaise9527" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Golang与C语言相互调用</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://shenbaise9527.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>深白色</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/golang/"><i class="far fa-folder fa-fw"></i>Golang</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-07-24">2021-07-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2932 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 6 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#类型对应关系">类型对应关系</a></li>
    <li><a href="#导出函数">导出函数</a></li>
    <li><a href="#字符串">字符串</a></li>
    <li><a href="#c中struct的定义">C中struct的定义</a></li>
    <li><a href="#golang中引用c语言">Golang中引用C语言</a></li>
    <li><a href="#c语言中引用golang">C语言中引用Golang</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>主要是描述Go语言调用易盛行情API的动态库过程中，一些需要注意的地方。</p>
<h2 id="类型对应关系">类型对应关系</h2>
<table>
<thead>
<tr>
<th style="text-align:left">C类型</th>
<th style="text-align:left">调用方法</th>
<th style="text-align:left">Go类型</th>
<th style="text-align:left">字节数</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">char</td>
<td style="text-align:left">C.char</td>
<td style="text-align:left">byte</td>
<td style="text-align:left">1</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">signed char</td>
<td style="text-align:left">C.schar</td>
<td style="text-align:left">int8</td>
<td style="text-align:left">1</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">unsigned char</td>
<td style="text-align:left">C.uchar</td>
<td style="text-align:left">uint8</td>
<td style="text-align:left">1</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">short int</td>
<td style="text-align:left">C.short</td>
<td style="text-align:left">int16</td>
<td style="text-align:left">2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">short unsigned int</td>
<td style="text-align:left">C.ushort</td>
<td style="text-align:left">uint16</td>
<td style="text-align:left">2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">int</td>
<td style="text-align:left">C.int</td>
<td style="text-align:left">int</td>
<td style="text-align:left">4</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">unsigned int</td>
<td style="text-align:left">C.uint</td>
<td style="text-align:left">uint32</td>
<td style="text-align:left">4</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">long int</td>
<td style="text-align:left">C.long</td>
<td style="text-align:left">int32 or int64</td>
<td style="text-align:left">4</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">long unsigned int</td>
<td style="text-align:left">C.ulong</td>
<td style="text-align:left">uint32 or uint64</td>
<td style="text-align:left">4</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">long long int</td>
<td style="text-align:left">C.longlong</td>
<td style="text-align:left">int64</td>
<td style="text-align:left">8</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">long long unsigned int</td>
<td style="text-align:left">C.ulonglong</td>
<td style="text-align:left">uint64</td>
<td style="text-align:left">8</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">float</td>
<td style="text-align:left">C.float</td>
<td style="text-align:left">float32</td>
<td style="text-align:left">4</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">double</td>
<td style="text-align:left">C.double</td>
<td style="text-align:left">float64</td>
<td style="text-align:left">8</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">wchar_t</td>
<td style="text-align:left">C.wchar_t</td>
<td style="text-align:left"></td>
<td style="text-align:left">2</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">void *</td>
<td style="text-align:left">unsafe.Pointer</td>
<td style="text-align:left"></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="导出函数">导出函数</h2>
<p>采用C++风格编译时,函数名会加上修饰符,会导致CGO查找不到对应的函数.所以必须采用C风格编译,这样函数名才会保持不变.</p>
<p>如下,就是采用C风格编译.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#ifdef __cplusplus
</span><span class="cp"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span><span class="p">{</span>
<span class="cp">#endif
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">Login</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">authCode</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">logPath</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">userName</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">passwd</span><span class="p">);</span>
<span class="p">......</span>

<span class="cp">#ifdef __cplusplus
</span><span class="cp"></span><span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>使用命令<code>nm libesunny.so</code>来查看动态库的符号表,可以看到函数<code>Login</code>的符号信息为<code>0000000000001fb0 T Login</code>,与名字是一样.</p>
<h2 id="字符串">字符串</h2>
<p>在C中用结尾带'\0&rsquo;的字符数组来表示字符串的,而在Golang中string类型是原生类型,因此两种语言互操作时是需要进行字符串类型转换的.</p>
<p>通过<code>C.String</code>函数可以将Golang中的<code>string</code>类型转换为C的字符串类型,再传给C函数使用.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Golang中的字符串.
</span><span class="c1"></span><span class="nx">s</span> <span class="o">:=</span> <span class="s">&#34;hello cgo\n&#34;</span>
<span class="c1">// 转换为C的字符串.
</span><span class="c1"></span><span class="nx">cs</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="c1">// 传给C函数Print使用.
</span><span class="c1"></span><span class="nx">C</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">cs</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>需要注意,转换后的<code>cs</code>并不能由Golang的GC所管理,必须手动释放<code>cs</code>所占用的内存,即必须显示调用<code>C.free</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Golang中的字符串.
</span><span class="c1"></span><span class="nx">s</span> <span class="o">:=</span> <span class="s">&#34;hello cgo\n&#34;</span>
<span class="c1">// 转换为C的字符串.
</span><span class="c1"></span><span class="nx">cs</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="c1">// 传给C函数Print使用.
</span><span class="c1"></span><span class="nx">C</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">cs</span><span class="p">)</span>

<span class="c1">// 显示释放cs的内存.
</span><span class="c1"></span><span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">cs</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="c中struct的定义">C中struct的定义</h2>
<p><strong>第一种方式</strong></p>
<p>定义如下结构体.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">// 品种编码结构.
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">ESunnyCommodity</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">ExchangeNo</span><span class="p">;</span>               <span class="c1">///&lt; 交易所编码
</span><span class="c1"></span>    <span class="kt">char</span>  <span class="n">CommodityType</span><span class="p">;</span>            <span class="c1">///&lt; 品种类型
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">CommodityNo</span><span class="p">;</span>              <span class="c1">///&lt; 品种编号
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>若在其它结构体或函数中引用了上述<code>ESunnyCommodity</code>结构体,则必须显示申明为<code>struct</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">// 品种信息.
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">ESunnyCommodityInfo</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">ESunnyCommodity</span> <span class="n">Commodity</span><span class="p">;</span>            <span class="c1">///&lt; 品种
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span>                  <span class="n">CommodityName</span><span class="p">;</span>        <span class="c1">///&lt; 品种名称,GBK编码格式
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span>                  <span class="n">CommodityEngName</span><span class="p">;</span>     <span class="c1">///&lt; 品种英文名称
</span><span class="c1"></span>    <span class="kt">double</span>                 <span class="n">ContractSize</span><span class="p">;</span>         <span class="c1">///&lt; 每手乘数
</span><span class="c1"></span>    <span class="kt">double</span>                 <span class="n">CommodityTickSize</span><span class="p">;</span>    <span class="c1">///&lt; 最小变动价位
</span><span class="c1"></span>    <span class="kt">int</span>                    <span class="n">CommodityDenominator</span><span class="p">;</span> <span class="c1">///&lt; 报价分母
</span><span class="c1"></span>    <span class="kt">char</span>                   <span class="n">CmbDirect</span><span class="p">;</span>            <span class="c1">///&lt; 组合方向
</span><span class="c1"></span>    <span class="kt">int</span>                    <span class="n">CommodityContractLen</span><span class="p">;</span> <span class="c1">///&lt; 品种合约年限
</span><span class="c1"></span>    <span class="kt">char</span>                   <span class="n">IsDST</span><span class="p">;</span>                <span class="c1">///&lt; 是否夏令时,&#39;Y&#39;为是,&#39;N&#39;为否
</span><span class="c1"></span>    <span class="k">struct</span> <span class="nc">ESunnyCommodity</span> <span class="n">RelateCommodity1</span><span class="p">;</span>     <span class="c1">///&lt; 关联品种1
</span><span class="c1"></span>    <span class="k">struct</span> <span class="nc">ESunnyCommodity</span> <span class="n">RelateCommodity2</span><span class="p">;</span>     <span class="c1">///&lt; 关联品种2
</span><span class="c1"></span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">QryCommodity</span><span class="p">(</span><span class="k">struct</span> <span class="nc">ESunnyCommodityInfo</span><span class="o">**</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">len</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>在上述引用的两个例子中,必须在<code>ESunnyCommodityInfo</code>前面显示说明为<code>struct</code>.否则在编译Golang代码时会报错<code>error: unknown type name 'ESunnyCommodityInfo'</code></p>
<p><strong>第二种方式</strong></p>
<p>结构体采用如下方式定义.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">// 品种编码结构.
</span><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">ExchangeNo</span><span class="p">;</span>               <span class="c1">///&lt; 交易所编码
</span><span class="c1"></span>    <span class="kt">char</span>  <span class="n">CommodityType</span><span class="p">;</span>            <span class="c1">///&lt; 品种类型
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">CommodityNo</span><span class="p">;</span>              <span class="c1">///&lt; 品种编号
</span><span class="c1"></span><span class="p">}</span><span class="n">ESunnyCommodity</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>其它结构体或函数可以直接引用<code>ESunnyCommodity</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">// 品种信息.
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">ESunnyCommodityInfo</span> <span class="p">{</span>
    <span class="n">ESunnyCommodity</span> <span class="n">Commodity</span><span class="p">;</span>            <span class="c1">///&lt; 品种
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span>                  <span class="n">CommodityName</span><span class="p">;</span>        <span class="c1">///&lt; 品种名称,GBK编码格式
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span>                  <span class="n">CommodityEngName</span><span class="p">;</span>     <span class="c1">///&lt; 品种英文名称
</span><span class="c1"></span>    <span class="kt">double</span>                 <span class="n">ContractSize</span><span class="p">;</span>         <span class="c1">///&lt; 每手乘数
</span><span class="c1"></span>    <span class="kt">double</span>                 <span class="n">CommodityTickSize</span><span class="p">;</span>    <span class="c1">///&lt; 最小变动价位
</span><span class="c1"></span>    <span class="kt">int</span>                    <span class="n">CommodityDenominator</span><span class="p">;</span> <span class="c1">///&lt; 报价分母
</span><span class="c1"></span>    <span class="kt">char</span>                   <span class="n">CmbDirect</span><span class="p">;</span>            <span class="c1">///&lt; 组合方向
</span><span class="c1"></span>    <span class="kt">int</span>                    <span class="n">CommodityContractLen</span><span class="p">;</span> <span class="c1">///&lt; 品种合约年限
</span><span class="c1"></span>    <span class="kt">char</span>                   <span class="n">IsDST</span><span class="p">;</span>                <span class="c1">///&lt; 是否夏令时,&#39;Y&#39;为是,&#39;N&#39;为否
</span><span class="c1"></span>    <span class="n">ESunnyCommodity</span> <span class="n">RelateCommodity1</span><span class="p">;</span>     <span class="c1">///&lt; 关联品种1
</span><span class="c1"></span>    <span class="n">ESunnyCommodity</span> <span class="n">RelateCommodity2</span><span class="p">;</span>     <span class="c1">///&lt; 关联品种2
</span><span class="c1"></span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">QryCommodity</span><span class="p">(</span><span class="n">ESunnyCommodityInfo</span><span class="o">**</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">len</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="golang中引用c语言">Golang中引用C语言</h2>
<p><strong>头文件和库的引用</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">wrapper</span>

<span class="cm">/*
</span><span class="cm">#cgo CFLAGS: -I../esunny/include
</span><span class="cm">#cgo LDFLAGS: -L../esunny/lib -lesunny -lTapQuoteAPI
</span><span class="cm">
</span><span class="cm">#include &lt;stdlib.h&gt;
</span><span class="cm">#include &#34;export.h&#34;
</span><span class="cm">#include &#34;tap.h&#34;
</span><span class="cm">*/</span>
<span class="kn">import</span> <span class="s">&#34;C&#34;</span>

<span class="kn">import</span> <span class="p">(</span>
<span class="s">&#34;encoding/json&#34;</span>
<span class="s">&#34;errors&#34;</span>
<span class="s">&#34;quote/source/tap/config&#34;</span>
<span class="s">&#34;time&#34;</span>
<span class="s">&#34;unsafe&#34;</span>

<span class="s">&#34;github.com/tal-tech/go-zero/core/logx&#34;</span>
<span class="s">&#34;github.com/tal-tech/go-zero/core/threading&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如上所述,在<code>package</code>下面通过注释的方式引入C.</p>
<ul>
<li><code>#cgo CFLAGS: -I../esunny/include</code>,表示引用的C头文件的目录.</li>
<li><code>#cgo LDFLAGS: -L../esunny/lib -lesunny -lTapQuoteAPI</code>,表示引用的C动态库的路径及名字.</li>
<li><code>#include &lt;stdlib.h&gt;</code>,引入系统头文件,<strong>如果引用了函数<code>C.free</code>,就需要该头文件</strong>.</li>
<li><code>#include &quot;export.h&quot;</code>,表示引用的动态库对应的头文件.</li>
<li><code>import &quot;C&quot;</code>,必须紧跟在注释后面,中间不能有空行,否则会报错.</li>
</ul>
<p><strong>调用C函数</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">api</span> <span class="o">*</span><span class="nx">ESApi</span><span class="p">)</span> <span class="nf">SubscribeTick</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span> <span class="p">{</span>
		<span class="c1">// 把golang的string类型转换为C的char*
</span><span class="c1"></span>		<span class="nx">cExchangeNo</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">)</span>
		<span class="nx">cCommoditNo</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">)</span>
		<span class="nx">cContractNo</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ContractNo1</span><span class="p">)</span>
		<span class="c1">// C.char把golang的byte转换为C的char
</span><span class="c1"></span>		<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">SubscribeTick</span><span class="p">(</span><span class="nx">cExchangeNo</span><span class="p">,</span> <span class="nx">cCommoditNo</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nf">char</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">),</span> <span class="nx">cContractNo</span><span class="p">)</span>

		<span class="c1">// 调用C.free释放内存.
</span><span class="c1"></span>		<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">cExchangeNo</span><span class="p">))</span>
		<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">cCommoditNo</span><span class="p">))</span>
		<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">cContractNo</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">logx</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;subscrbe tick failed: %d, exchangeNo: %s, commoditNo: %s, contractNo: %s, commoditType: %s&#34;</span><span class="p">,</span>
				<span class="nx">ret</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">,</span>
				<span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ContractNo1</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">))</span>

			<span class="k">continue</span>
		<span class="p">}</span>

		<span class="nx">logx</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;subscrbe tick successfully, exchangeNo: %s, commoditNo: %s, contractNo: %s, commoditType: %s&#34;</span><span class="p">,</span>
			<span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">,</span>
			<span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">ContractNo1</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">contractDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Contract</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>访问C的结构体数组</strong></p>
<p>C函数原型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cm">/**
</span><span class="cm"> * 查询品种信息,在外部要释放info对应的内存.
</span><span class="cm"> * @param out info 品种信息数组.
</span><span class="cm"> * @param out len 数组长度.
</span><span class="cm"> *
</span><span class="cm"> * @return 错误码,0-表示成功.
</span><span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">QryCommodity</span><span class="p">(</span><span class="k">struct</span> <span class="nc">ESunnyCommodityInfo</span><span class="o">**</span> <span class="n">info</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">len</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Golang调用代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">api</span> <span class="o">*</span><span class="nx">ESApi</span><span class="p">)</span> <span class="nf">QryCommodity</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// 查询品种.
</span><span class="c1"></span>	<span class="nx">api</span><span class="p">.</span><span class="nx">commodityDatas</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="c1">// 定义C中结构体ESunnyCommodityInfo的指针变量.
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">commodityInfo</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">struct_ESunnyCommodityInfo</span>
	<span class="c1">// 定义C中的int变量
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">commodityLen</span> <span class="nx">C</span><span class="p">.</span><span class="kt">int</span>
	<span class="c1">// 调用C函数.
</span><span class="c1"></span>	<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">QryCommodity</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">commodityInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">commodityLen</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">logx</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;qry commodity err: %d&#34;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">)</span>

		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;query commodity failed&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 把C中的int变量强制类型转换为golang中的int.
</span><span class="c1"></span>	<span class="nx">cLen</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">commodityLen</span><span class="p">)</span>
	<span class="c1">// 强制转换为uintptr,后续需要做指针运算.
</span><span class="c1"></span>	<span class="nx">commodityPointer</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">commodityInfo</span><span class="p">))</span>
	<span class="nx">api</span><span class="p">.</span><span class="nx">commodityDatas</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">SourceCommodityInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cLen</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">cLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="c1">// 强制转换为C的结构体对象.
</span><span class="c1"></span>		<span class="nx">info</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">struct_ESunnyCommodityInfo</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">commodityPointer</span><span class="p">))</span>
		<span class="c1">// 指针运算,指向下一个结构体对象.
</span><span class="c1"></span>		<span class="nx">commodityPointer</span> <span class="o">+=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span>
		<span class="nx">data</span> <span class="o">:=</span> <span class="nx">SourceCommodityInfo</span><span class="p">{</span>
			<span class="nx">Commodity</span><span class="p">:</span> <span class="nx">SourceCommodity</span><span class="p">{</span>
				<span class="c1">// 把C的char*转换为golang的string类型.
</span><span class="c1"></span>				<span class="nx">ExchangeNo</span><span class="p">:</span>    <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Commodity</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">),</span>  <span class="c1">///&lt; 交易所编码
</span><span class="c1"></span>				<span class="c1">// 把C的char转换为golang的byte类型.
</span><span class="c1"></span>				<span class="nx">CommodityType</span><span class="p">:</span> <span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Commodity</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">),</span>     <span class="c1">///&lt; 品种类型
</span><span class="c1"></span>				<span class="nx">CommodityNo</span><span class="p">:</span>   <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Commodity</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">),</span> <span class="c1">///&lt; 品种编号
</span><span class="c1"></span>			<span class="p">},</span> <span class="c1">///&lt; 品种
</span><span class="c1"></span>			<span class="nx">CommodityName</span><span class="p">:</span>        <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CommodityName</span><span class="p">),</span>    <span class="c1">///&lt; 品种名称,GBK编码格式
</span><span class="c1"></span>			<span class="nx">CommodityEngName</span><span class="p">:</span>     <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CommodityEngName</span><span class="p">),</span> <span class="c1">///&lt; 品种英文名称
</span><span class="c1"></span>			<span class="c1">// 把C的double转换为golang的float64类型.
</span><span class="c1"></span>			<span class="nx">ContractSize</span><span class="p">:</span>         <span class="nb">float64</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">ContractSize</span><span class="p">),</span>        <span class="c1">///&lt; 每手乘数
</span><span class="c1"></span>			<span class="nx">CommodityTickSize</span><span class="p">:</span>    <span class="nb">float64</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CommodityTickSize</span><span class="p">),</span>   <span class="c1">///&lt; 最小变动价位
</span><span class="c1"></span>			<span class="c1">// 把C的int转换为golang的int类型.
</span><span class="c1"></span>			<span class="nx">CommodityDenominator</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CommodityDenominator</span><span class="p">),</span>    <span class="c1">///&lt; 报价分母
</span><span class="c1"></span>			<span class="nx">CmbDirect</span><span class="p">:</span>            <span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CmbDirect</span><span class="p">),</span>              <span class="c1">///&lt; 组合方向
</span><span class="c1"></span>			<span class="nx">CommodityContractLen</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">CommodityContractLen</span><span class="p">),</span>    <span class="c1">///&lt; 品种合约年限
</span><span class="c1"></span>			<span class="nx">IsDST</span><span class="p">:</span>                <span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">IsDST</span><span class="p">),</span>                  <span class="c1">///&lt; 是否夏令时,&#39;Y&#39;为是,&#39;N&#39;为否
</span><span class="c1"></span>			<span class="nx">RelateCommodity1</span><span class="p">:</span> <span class="nx">SourceCommodity</span><span class="p">{</span>
				<span class="nx">ExchangeNo</span><span class="p">:</span>    <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity1</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">),</span>  <span class="c1">///&lt; 交易所编码
</span><span class="c1"></span>				<span class="nx">CommodityType</span><span class="p">:</span> <span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity1</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">),</span>     <span class="c1">///&lt; 品种类型
</span><span class="c1"></span>				<span class="nx">CommodityNo</span><span class="p">:</span>   <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity1</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">),</span> <span class="c1">///&lt; 品种编号
</span><span class="c1"></span>			<span class="p">},</span> <span class="c1">///&lt; 关联品种1
</span><span class="c1"></span>			<span class="nx">RelateCommodity2</span><span class="p">:</span> <span class="nx">SourceCommodity</span><span class="p">{</span>
				<span class="nx">ExchangeNo</span><span class="p">:</span>    <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity2</span><span class="p">.</span><span class="nx">ExchangeNo</span><span class="p">),</span>  <span class="c1">///&lt; 交易所编码
</span><span class="c1"></span>				<span class="nx">CommodityType</span><span class="p">:</span> <span class="nb">byte</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity2</span><span class="p">.</span><span class="nx">CommodityType</span><span class="p">),</span>     <span class="c1">///&lt; 品种类型
</span><span class="c1"></span>				<span class="nx">CommodityNo</span><span class="p">:</span>   <span class="nx">C</span><span class="p">.</span><span class="nf">GoString</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">RelateCommodity2</span><span class="p">.</span><span class="nx">CommodityNo</span><span class="p">),</span> <span class="c1">///&lt; 品种编号
</span><span class="c1"></span>			<span class="p">},</span> <span class="c1">///&lt; 关联品种2
</span><span class="c1"></span>		<span class="p">}</span>

		<span class="nx">api</span><span class="p">.</span><span class="nx">commodityDatas</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">commodityDatas</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
		<span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="nx">logx</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c1">// 调用C.free释放内存.
</span><span class="c1"></span>	<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">commodityInfo</span><span class="p">))</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>总结</strong></p>
<ul>
<li>通过引入<code>C</code>包,来访问C代码.&ldquo;C&quot;不是一个具体的包名,可理解成一个伪包,C语言所有语法元素均在该伪包下面.</li>
<li><code>import &quot;C&quot;</code>是必须的,且其与上面的C代码之间不能有空行,必须紧密相连.</li>
<li><code>C.CString</code>可以把golang的string类型转换为C的char*(后续需要显示调用<code>C.free</code>来释放内存),<code>C.GoString</code>可以把C的char*转换为golang的string类型.</li>
<li>其它基础类型可以直接强制类型转换.</li>
<li>访问C的结构体对象时,采用<code>C.struct_xxx</code>来定义结构体对象,之后可以直接访问到结构体成员.</li>
<li>访问C的结构体数组时,是通过指针运算来顺序访问每个对象的,需要使用<code>uintptr</code>和<code>unsafe.Pointer</code>.</li>
</ul>
<h2 id="c语言中引用golang">C语言中引用Golang</h2>
<p>易盛行情API中涉及实时行情推送,需要有对应的回调函数.</p>
<p>C中定义回调函数原型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#ifdef __cplusplus
</span><span class="cp"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
<span class="cp">#endif
</span><span class="cp"></span>
<span class="cm">/**
</span><span class="cm"> * 外部函数,仅定义原型,接收tick数据回调.
</span><span class="cm"> * @param in info tick数据.
</span><span class="cm"> *
</span><span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OnTick</span><span class="p">(</span><span class="k">struct</span> <span class="nc">ESunnyTickWhole</span><span class="o">*</span> <span class="n">info</span><span class="p">);</span>

<span class="cm">/**
</span><span class="cm"> * 外部函数,仅定义原型,api断开连接回调.
</span><span class="cm"> * @param in errorCode 错误码.
</span><span class="cm"> *
</span><span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">OnDisconnect</span><span class="p">(</span><span class="kt">int</span> <span class="n">errorCode</span><span class="p">);</span>

<span class="cp">#ifdef __cplusplus
</span><span class="cp"></span><span class="p">}</span>
<span class="cp">#endif
</span></code></pre></td></tr></table>
</div>
</div><p>Golang中函数实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//export OnTick
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">OnTick</span><span class="p">(</span><span class="nx">info</span> <span class="o">*</span><span class="nx">C</span><span class="p">.</span><span class="nx">struct_ESunnyTickWhole</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">//export OnDisconnect
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">OnDisconnect</span><span class="p">(</span><span class="nx">errorCode</span> <span class="nx">C</span><span class="p">.</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如上,采用<code>//export</code>方式来申明函数是导出的.注意<code>//</code>和<code>export</code>之间不能有空格.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-07-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2021/07/24/golang-c-call/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://shenbaise9527.com/2021/07/24/golang-c-call/" data-title="Golang与C语言相互调用" data-via="shenbaise9527" data-hashtags="go,cgo"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://shenbaise9527.com/2021/07/24/golang-c-call/" data-hashtag="go"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://shenbaise9527.com/2021/07/24/golang-c-call/" data-title="Golang与C语言相互调用"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go/">go</a>,&nbsp;<a href="/tags/cgo/">cgo</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2021/07/24/golang-string/" class="prev" rel="prev" title="golang字符串解析"><i class="fas fa-angle-left fa-fw"></i>golang字符串解析</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.87.0-DEV">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://shenbaise9527.com" target="_blank">深白色</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-R1HW7DNZ94', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-R1HW7DNZ94" async></script></body>
</html>
