<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Jaeger指南 - 深白色9527</title><meta name="Description" content="深白色9527"><meta property="og:title" content="Jaeger指南" />
<meta property="og:description" content="系统架构 组件 jaeger即可以作为单体应用来部署(所有jaeger后台组件全部运行在一个进程内),也可以作为一个可扩展的分布式系统来部署.如" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shenbaise9527.com/opentracing-jaeger-guide/" /><meta property="og:image" content="https://shenbaise9527.com/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-14T21:06:14+08:00" />
<meta property="article:modified_time" content="2020-12-14T21:06:14+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shenbaise9527.com/logo.png"/>

<meta name="twitter:title" content="Jaeger指南"/>
<meta name="twitter:description" content="系统架构 组件 jaeger即可以作为单体应用来部署(所有jaeger后台组件全部运行在一个进程内),也可以作为一个可扩展的分布式系统来部署.如"/>
<meta name="application-name" content="深白色9527">
<meta name="apple-mobile-web-app-title" content="深白色9527"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://shenbaise9527.com/opentracing-jaeger-guide/" /><link rel="prev" href="https://shenbaise9527.com/opentracing-zipkin-guide/" /><link rel="next" href="https://shenbaise9527.com/opentracing-jaeger-action/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Jaeger指南",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/shenbaise9527.com\/opentracing-jaeger-guide\/"
        },"image": ["https:\/\/shenbaise9527.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "OpenTracing","wordcount":  8770 ,
        "url": "https:\/\/shenbaise9527.com\/opentracing-jaeger-guide\/","datePublished": "2020-12-14T21:06:14+08:00","dateModified": "2020-12-14T21:06:14+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/shenbaise9527.com\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "深白色"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="深白色9527"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>深白色9527</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/shenbaise9527" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="深白色9527"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>深白色9527</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/shenbaise9527" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Jaeger指南</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://shenbaise9527.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>深白色</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/microservice/"><i class="far fa-folder fa-fw"></i>Microservice</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-12-14">2020-12-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8770 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 18 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#系统架构">系统架构</a>
      <ul>
        <li><a href="#组件">组件</a></li>
        <li><a href="#客户端库">客户端库</a></li>
        <li><a href="#agent">Agent</a></li>
        <li><a href="#collector">Collector</a></li>
        <li><a href="#query">Query</a></li>
        <li><a href="#ingester">Ingester</a></li>
      </ul>
    </li>
    <li><a href="#reporting-apis">Reporting APIs</a>
      <ul>
        <li><a href="#thrift-over-udp">Thrift over UDP</a></li>
        <li><a href="#grpc">gRPC</a></li>
        <li><a href="#thrift-over-http">Thrift over HTTP</a></li>
        <li><a href="#zipkin格式">Zipkin格式</a></li>
      </ul>
    </li>
    <li><a href="#采样策略">采样策略</a>
      <ul>
        <li><a href="#客户端采样配置">客户端采样配置</a></li>
        <li><a href="#自适应采样">自适应采样</a></li>
        <li><a href="#collector采样配置">Collector采样配置</a></li>
      </ul>
    </li>
    <li><a href="#部署">部署</a>
      <ul>
        <li><a href="#配置选项">配置选项</a></li>
        <li><a href="#agent-1">Agent</a>
          <ul>
            <li><a href="#服务发现集成">服务发现集成</a></li>
            <li><a href="#代理层标签">代理层标签</a></li>
          </ul>
        </li>
        <li><a href="#收集器">收集器</a></li>
        <li><a href="#后端存储">后端存储</a>
          <ul>
            <li><a href="#memory">Memory</a></li>
            <li><a href="#badger---本地存储">Badger - 本地存储</a></li>
            <li><a href="#cassandra">Cassandra</a></li>
            <li><a href="#elasticsearch">Elasticsearch</a></li>
            <li><a href="#kafka">Kafka</a></li>
            <li><a href="#存储插件">存储插件</a></li>
          </ul>
        </li>
        <li><a href="#ingester-1">Ingester</a></li>
        <li><a href="#query-service--ui">Query Service &amp; UI</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="系统架构">系统架构</h2>
<h3 id="组件">组件</h3>
<p>jaeger即可以作为单体应用来部署(所有jaeger后台组件全部运行在一个进程内),也可以作为一个可扩展的分布式系统来部署.如下所述.有两个主要的部署选项:</p>
<ul>
<li>Collectors直接把数据写入到存储中.</li>
<li>Collectors把数据写入到kafka中,作为缓冲,再异步写入存储.</li>
</ul>
<p>第一种情况,直接写入存储:
<figure><a class="lightgallery" href="/images/jaeger-architecture-v1.png" title="架构图1" data-thumbnail="/images/jaeger-architecture-v1.png" data-sub-html="<h2>直接写入存储的架构图</h2><p>架构图1</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/jaeger-architecture-v1.png"
            data-srcset="/images/jaeger-architecture-v1.png, /images/jaeger-architecture-v1.png 1.5x, /images/jaeger-architecture-v1.png 2x"
            data-sizes="auto"
            alt="/images/jaeger-architecture-v1.png" />
    </a><figcaption class="image-caption">直接写入存储的架构图</figcaption>
    </figure></p>
<p>第二种情况,先写入kafka:
<figure><a class="lightgallery" href="/images/jaeger-architecture-v2.png" title="架构图2" data-thumbnail="/images/jaeger-architecture-v2.png" data-sub-html="<h2>写入kafka的架构图</h2><p>架构图2</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/jaeger-architecture-v2.png"
            data-srcset="/images/jaeger-architecture-v2.png, /images/jaeger-architecture-v2.png 1.5x, /images/jaeger-architecture-v2.png 2x"
            data-sizes="auto"
            alt="/images/jaeger-architecture-v2.png" />
    </a><figcaption class="image-caption">写入kafka的架构图</figcaption>
    </figure></p>
<h3 id="客户端库">客户端库</h3>
<p>jaeger客户端是基于OpenTracing API的特定语言实现.它们可以为应用程序提供分布式追踪的能力,并能与已经集成OpenTracing的开源框架(如Flask,Dropwizard,gRPC等等)一起很好的协作.</p>
<p>当服务接收到新请求时会同时收到附加的上下文信息(trace id,span id和baggage),服务会基于上下文创建Span,然后继续往下游发送.在请求中仅仅相关id和baggage会被传播;而其它数据,如operation name,timing,tags和logs都不会被传播.这些数据会在后台被异步发送给jaeger服务.</p>
<p>为了降低负载,jager客户端提供了各种不同的采样策略.当一个trace被采样,其所有的span数据都会被抓取并被发送到jaeger服务.如果trace没有被采样,其所有的数据都不会被收集,并会对OpenTracing API实行熔断以减少开销.默认情况下,客户端的采样率为0.1%,并能从jaeger服务获取到采样策略(见上面架构图的adaptive sampling).
<figure><a class="lightgallery" href="/images/jaeger-context-prop.png" title="传播" data-thumbnail="/images/jaeger-context-prop.png" data-sub-html="<h2>传播</h2><p>传播</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/jaeger-context-prop.png"
            data-srcset="/images/jaeger-context-prop.png, /images/jaeger-context-prop.png 1.5x, /images/jaeger-context-prop.png 2x"
            data-sizes="auto"
            alt="/images/jaeger-context-prop.png" />
    </a><figcaption class="image-caption">传播</figcaption>
    </figure></p>
<h3 id="agent">Agent</h3>
<p>agent是一个网络代理服务,主要基于UDP协议来接收Span,然后把Span分批的发送给收集器.它是作为基础结构组件部署到所有主机上.该代理抽象的将收集器的路由和发现从客户端分离.</p>
<h3 id="collector">Collector</h3>
<p>collector从agent接收追踪数据,然后基于数据进行一系列的操作,当前操作有验证数据,建立索引,执行相关转换,最后存储.</p>
<p>存储是基于插件化设计的,当前支持Cassandra, Elasticsearch and Kafka.</p>
<h3 id="query">Query</h3>
<p>查询服务,从存储中检索trace,然后在UI上展示.</p>
<h3 id="ingester">Ingester</h3>
<p>从kafka中读取数据,然后写入其它的存储中(如Cassandra, Elasticsearch)</p>
<h2 id="reporting-apis">Reporting APIs</h2>
<p>Agent和Collector这两个组件都能接收Span数据.目前它们支持两组不重叠的API.</p>
<h3 id="thrift-over-udp">Thrift over UDP</h3>
<p>Agent只能基于UDP协议接收Thrift格式的Span数据.主要的API是处理的UDP包,其中包含<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/jaeger.thrift" target="_blank" rel="noopener noreffer">jaeger.thrift</a> IDL文件中定义的Thrift编码的Batch结构,该IDL文件位于<a href="https://github.com/jaegertracing/jaeger-idl/" target="_blank" rel="noopener noreffer">jaeger-idl</a>代码库中.大多数客户端库使用Thrift紧凑模式编码,但有些客户端库不支持(如Node.js),其会使用Thrift二进制模式编码(发送到不同的UDP端口上).API都定义在<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/agent.thrift" target="_blank" rel="noopener noreffer">agent.thrift</a> IDL文件中.</p>
<p>由于历史原因,Agent还能接收Zipkin格式的Span数据,但只有老版本的客户端库才能发送该格式的数据,目前官方已经正式弃用了.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Port</th>
<th style="text-align:left">Protocol</th>
<th style="text-align:left">Component</th>
<th style="text-align:left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">5775</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">agent</td>
<td style="text-align:left">接收<code>zipkin.thrift</code>的thrift协议的紧凑格式(已弃用,老版本客户端能使用)</td>
</tr>
<tr>
<td style="text-align:left">6831</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">agent</td>
<td style="text-align:left">接收<code>jaeger.thrift</code>的thrift协议的紧凑格式</td>
</tr>
<tr>
<td style="text-align:left">6832</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">agent</td>
<td style="text-align:left">接收<code>jaeger.thrift</code>的thrift协议的二进制格式</td>
</tr>
<tr>
<td style="text-align:left">5778</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">agent</td>
<td style="text-align:left">服务配置</td>
</tr>
</tbody>
</table>
<h3 id="grpc">gRPC</h3>
<p>在典型的jaeger部署中,Agent会从客户端接收Span数据然后将其转发给Collector.从jaeger 1.11版本开始,Agent与Collector之间的官方推荐协议是gRPC与Protobuf,协议定义在<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/proto/api_v2/collector.proto" target="_blank" rel="noopener noreffer">collector.proto</a> IDL文件中.</p>
<h3 id="thrift-over-http">Thrift over HTTP</h3>
<p>在某些情况下,将Agent和应用程序部署在一起是不可行的,比如当应用程序代码作为AWS的Lambda函数运行时.在这些场景下,jaeger客户端可以通过HTTP/HTTPS协议直接把Span数据发送给Collector.</p>
<p>基于相同<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/jaeger.thrift" target="_blank" rel="noopener noreffer">jaeger.thrift</a> IDL文件定义的数据可以以HTTP Post请求被提交给<code>/api/traces</code>端点,如<code>https://jaeger-collector:14268/api/traces</code>.Batch结构需要使用Thrift二进制格式编码,在HTTP头中要设置特殊的content type,<code>Content-Type: application/vnd.apache.thrift.binary</code>.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Port</th>
<th style="text-align:left">Protocol</th>
<th style="text-align:left">Component</th>
<th style="text-align:left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">14268</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">collector</td>
<td style="text-align:left">直接从客户端接收<code>jaeger.thrift</code></td>
</tr>
</tbody>
</table>
<h3 id="zipkin格式">Zipkin格式</h3>
<p>Collector也可以接受来自Zipkin格式的Span数据,基于JSON v1/v2和Thrift.Collector需要配置为启用Zipkin HTTP服务,如在9411端口启用被当做Zipkin收集器.服务启用了两个端点来接受POST请求:</p>
<ul>
<li><code>/api/v1/spans</code>,用来接受Zipkin的JSON v1或Thrift格式的数据.</li>
<li><code>/api/v2/spans</code>,用来接受Zipkin的JSON v2格式的数据.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Port</th>
<th style="text-align:left">Protocol</th>
<th style="text-align:left">Component</th>
<th style="text-align:left">Function</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">9411</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">collector</td>
<td style="text-align:left">适配Zipkin(可选)</td>
</tr>
</tbody>
</table>
<h2 id="采样策略">采样策略</h2>
<p>Jaeger库实现了一致性的前端(或基于头部的)采样.举例,假设我们有一个简单的调用图,其中服务A调用服务B,服务B调用服务C:<code>A-&gt;B-&gt;C</code>.当服务A接收到一个没有包含追踪信息的请求时,会开启一个新的<code>trace</code>,并分配一个随机的trade ID,然后基于当前的采样策略会对该<code>trace</code>做出一个采样决策.这个决策会跟随这个请求传播到服务B和服务C,因此服务B和C不在需要进行采样决策,而是尊重顶级服务A的采样决策.这种方法保证了如果一个<code>trace</code>被采样了,其所有的<code>spans</code>都会被记录到Jaeger服务中.如果每个服务都在做自己的采样决策,那么在Jaeger服务中很少能获取到完整的追踪信息.</p>
<h3 id="客户端采样配置">客户端采样配置</h3>
<p>当使用配置对象去实例化一个tracer时,可以根据<code>sampler.type</code>和<code>sampler.param</code>属性来选择采样类型.Jaeger库支持如下采样策略:</p>
<ul>
<li>Constant(<code>sampler.type=const</code>),该采样策略会对所有trace采用相同的决策.如果<code>sampler.param=1</code>将对所有trace都采样,如果<code>sampler.param=0</code>将都不睬采样.</li>
<li>Probabilistic(<code>sampler.type=probabilistic</code>),该采样策略会基于<code>sampler.param</code>属性值做出一个概率性的随机决策.例如,<code>sampler.param=0.1</code>时大约在10个trace中会有1个被采样.</li>
<li>Rate Limiting(<code>sampler.type=ratelimiting</code>),该采样策略使用一个漏洞限流器来确保trace会按照一个恒定的速率被采样.例如,<code>sampler.param=2.0</code>时会按照每秒钟2个trace的速率来采样.</li>
<li>Remote(<code>sampler.type=remote</code>,也是默认策略),会向Jaeger Agent咨询在当前服务中使用的合适的采样策略.这允许从Jaeger服务的中心配置来控制服务的采样策略,甚至是动态的(参见自适应采样).</li>
</ul>
<h3 id="自适应采样">自适应采样</h3>
<p>自适应采样策略是一个组合策略,结合了两个功能:</p>
<ul>
<li>它在每个操作的基础上进行采样决策,即基于span的操作名称.这在API服务中是特别有用的,这些服务的端点可能有非常不同的流量,并且对整个服务使用单一的概率采样策略可能会导致饿死(无法采样)一些低QPS的端点.</li>
<li>它支持最小保证的采样率,如总是允许每秒最多N次trace,然后以一定的概率对超过这个频率的任何数据进行采样(所有操作都是按操作而不是按服务进行的).</li>
</ul>
<p>每个操作参数都可以静态配置或定期从Jaeger后端拉取(基于Remote采样策略).自适应采样策略是设计与Jaeger后端即将到来的自适应采样功能一起工作的.</p>
<h3 id="collector采样配置">Collector采样配置</h3>
<p>收集器可以使用静态采样策略(如果使用Remote采样配置,则将其传播到相应的服务),通过<code>--sampling.strategies-file</code>选项.此选项需要一个json文件的路径,该文件定义了采样策略.</p>
<p>如果没有相应的配置项,收集器会对所有服务返回默认的采样率为0.001(0.1%)的随机采样策略.</p>
<p>举例<code>strategies.json</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;service_strategies&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
      <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
      <span class="nt">&#34;operation_strategies&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;op1&#34;</span><span class="p">,</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
          <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.2</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;op2&#34;</span><span class="p">,</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
          <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.4</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">,</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ratelimiting&#34;</span><span class="p">,</span>
      <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;default_strategy&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
    <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="nt">&#34;operation_strategies&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;/health&#34;</span><span class="p">,</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
        <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;operation&#34;</span><span class="p">:</span> <span class="s2">&#34;/metrics&#34;</span><span class="p">,</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;probabilistic&#34;</span><span class="p">,</span>
        <span class="nt">&#34;param&#34;</span><span class="p">:</span> <span class="mf">0.0</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>service_strategies</code>元素定义了相关服务的特殊的采样策略,<code>operation_strategies</code>定义了相关操作的特殊的采样策略.这儿用到了两种策略:<code>probabilistic</code>和<code>ratelimiting</code>,可以参见<a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e9%87%87%e6%a0%b7%e9%85%8d%e7%bd%ae" rel="">客户端采样配置</a>(注意:<code>ratelimiting</code>不支持<code>operation_strategies</code>).<code>default_strategy</code>定义默认采样策略,适用于所有没有包含在<code>service_strategies</code>里的服务.</p>
<p>在上面的例子中:</p>
<ul>
<li>服务<code>foo</code>的所有操作会按照0.8的概率被采用,除了操作<code>op1</code>和<code>op2</code>,<code>op1</code>会按照0.2的概率,<code>op2</code>会按照0.4的概率.</li>
<li>服务<code>bar</code>的所有操作会按照每秒5个trace的速率来采样.</li>
<li>其它任何服务都会按照<code>default_strategy</code>中定义的0.5的概率被采样.</li>
<li><code>default_strategy</code>还包括每个操作共享的策略.在这个例子中我们通过使用0概率来禁用了所有服务中对包含<code>/health</code>和<code>/metrics</code>端点的追踪.这些每个操作策略将应用于配置中未列出的任何新服务，以及<code>foo</code>和<code>bar</code>服务，除非它们为这两个操作定义了自己的策略。</li>
</ul>
<h2 id="部署">部署</h2>
<p>主要的Jaeger后端组件已经作为镜像发布在<a href="https://hub.docker.com" target="_blank" rel="noopener noreffer">Docker Hub</a>上:</p>
<table>
<thead>
<tr>
<th style="text-align:left">组件</th>
<th style="text-align:left">仓库地址</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">jaeger-agent</td>
<td style="text-align:left"><a href="https://hub.docker.com/r/jaegertracing/jaeger-agent" target="_blank" rel="noopener noreffer">hub.docker.com/r/jaegertracing/jaeger-agent</a></td>
</tr>
<tr>
<td style="text-align:left">jaeger-collector</td>
<td style="text-align:left"><a href="https://hub.docker.com/r/jaegertracing/jaeger-collector" target="_blank" rel="noopener noreffer">hub.docker.com/r/jaegertracing/jaeger-collector</a></td>
</tr>
<tr>
<td style="text-align:left">jaeger-query</td>
<td style="text-align:left"><a href="https://hub.docker.com/r/jaegertracing/jaeger-query" target="_blank" rel="noopener noreffer">hub.docker.com/r/jaegertracing/jaeger-query</a></td>
</tr>
<tr>
<td style="text-align:left">jaeger-ingester</td>
<td style="text-align:left"><a href="https://hub.docker.com/r/jaegertracing/jaeger-ingester" target="_blank" rel="noopener noreffer">hub.docker.com/r/jaegertracing/jaeger-ingester</a></td>
</tr>
</tbody>
</table>
<p>下面是为了运行Jaeger而编排的模板:</p>
<ul>
<li>Kubernetes: <a href="https://github.com/jaegertracing/jaeger-kubernetes" target="_blank" rel="noopener noreffer">jaeger-kubernetes</a></li>
<li>OpenShift: <a href="https://github.com/jaegertracing/jaeger-openshit" target="_blank" rel="noopener noreffer">jaeger-openshit</a></li>
</ul>
<h3 id="配置选项">配置选项</h3>
<p>Jaeger二进制文件可以采用下面几种方式来配置(优先级递减):</p>
<ul>
<li>命令行参数.</li>
<li>环境变量.</li>
<li>配置文件(JSON,TOML,YAML,HCL等格式)或Java属性格式.</li>
</ul>
<p>要查看选项的完整列表,可以通过运行二进制文件的<code>help</code>命令或参考<a href="https://www.jaegertracing.io/docs/1.21/cli/" target="_blank" rel="noopener noreffer">CLI Flags</a>页以获得更多信息.只有在选择存储类型时,才会列出特定于某个存储后端的选项.当在使用<code>Cassandra</code>存储时查看所有可用的选项,使用命令<code>docker run --rm -e SPAN_STORAGE_TYPE=cassandra jaegertracing/jaeger-collector:1.21 help</code>.</p>
<p>为了通过环境变量来提供配置参数,查找相应的命令行选项并将其名称转换为大写格式.如:</p>
<table>
<thead>
<tr>
<th style="text-align:left">命令行选项</th>
<th style="text-align:left">环境变量</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&ndash;cassandra.connections-per-host</td>
<td style="text-align:left">CASSANDRA_CONNECTIONS_PER_HOST</td>
</tr>
<tr>
<td style="text-align:left">&ndash;metrics-backend</td>
<td style="text-align:left">METRICS_BACKEND</td>
</tr>
</tbody>
</table>
<h3 id="agent-1">Agent</h3>
<p>Jaeger客户端库期望<code>jaeger-agent</code>进程在每个主机上本地运行.agent暴露的端口信息:</p>
<table>
<thead>
<tr>
<th style="text-align:left">端口号</th>
<th style="text-align:left">协议</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">6831</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">接收紧凑格式的<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/jaeger.thrift" target="_blank" rel="noopener noreffer">jaeger.thrift</a>协议,大多数Jaeger客户端使用的</td>
</tr>
<tr>
<td style="text-align:left">6832</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">接收二进制格式的<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/jaeger.thrift" target="_blank" rel="noopener noreffer">jaeger.thrift</a>协议,主要是Node.js客户端使用</td>
</tr>
<tr>
<td style="text-align:left">5778</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">服务配置,采样策略</td>
</tr>
<tr>
<td style="text-align:left">5775</td>
<td style="text-align:left">UDP</td>
<td style="text-align:left">接收紧凑格式的<a href="https://github.com/jaegertracing/jaeger-idl/blob/master/thrift/zipkincore.thrift" target="_blank" rel="noopener noreffer">zipkin.thrift</a>协议(已弃用,老客户端使用)</td>
</tr>
<tr>
<td style="text-align:left">14271</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">管理端口:健康检查<code>/</code>和指标<code>/metrics</code></td>
</tr>
</tbody>
</table>
<p>可以在主机上直接运行或采用Docker方式运行:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## make sure to expose only the ports you use in your deployment scenario!</span>
docker run <span class="se">\
</span><span class="se"></span>  --rm <span class="se">\
</span><span class="se"></span>  -p6831:6831/udp <span class="se">\
</span><span class="se"></span>  -p6832:6832/udp <span class="se">\
</span><span class="se"></span>  -p5778:5778/tcp <span class="se">\
</span><span class="se"></span>  -p5775:5775/udp <span class="se">\
</span><span class="se"></span>  jaegertracing/jaeger-agent:1.21
</code></pre></td></tr></table>
</div>
</div><h4 id="服务发现集成">服务发现集成</h4>
<p>Agents可以点对点连接到单个Collector上,也可以依赖其它基础组件(如NDS)在多个Collector之间负载均衡.Agent也可以配置一个静态的Collector服务地址的列表.</p>
<p>采用Docker启动,命令行如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker run <span class="se">\
</span><span class="se"></span>  --rm <span class="se">\
</span><span class="se"></span>  -p5775:5775/udp <span class="se">\
</span><span class="se"></span>  -p6831:6831/udp <span class="se">\
</span><span class="se"></span>  -p6832:6832/udp <span class="se">\
</span><span class="se"></span>  -p5778:5778/tcp <span class="se">\
</span><span class="se"></span>  jaegertracing/jaeger-agent:1.21 <span class="se">\
</span><span class="se"></span>  --reporter.grpc.host-port<span class="o">=</span>jaeger-collector.jaeger-infra.svc:14250
</code></pre></td></tr></table>
</div>
</div><p>当使用gRPC时,在负载均衡和名称解析上有几个选项:</p>
<ul>
<li>单个连接没有负载均衡.这是默认采用的方式<code>host:port</code>.(例如:<code>--reporter.grpc.host-port=jaeger-collector.jaeger-infra.svc:14250</code>)</li>
<li>静态主机名列表和轮训负载均衡.地址之间采用逗号分隔.(例如:<code>--reporter.grpc.host-port=jaeger-collector1:14250,jaeger-collector2:14250,jaeger-collector3:14250</code>)</li>
<li>动态DNS解析和轮训负载均衡.要获得这种能力,需要在地址前加上前缀<code>dns:///</code>,gRPC将尝试使用SRV记录(用于<a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md" target="_blank" rel="noopener noreffer">外部负载均衡</a>)、TXT记录(用于服务配置)和A记录来解析主机名.参考<a href="https://github.com/grpc/grpc/blob/master/doc/naming.md" target="_blank" rel="noopener noreffer">gRPC名称解析文档</a>和<a href="https://github.com/grpc/grpc-go/blob/master/resolver/dns/dns_resolver.go" target="_blank" rel="noopener noreffer">dns_resolver</a>获取更多信息.(例如:<code>--reporter.grpc.host-port=dns:///jaeger-collector.jaeger-infra.svc:14250</code>)</li>
</ul>
<h4 id="代理层标签">代理层标签</h4>
<p>Jaeger支持代理层标签,这些标签可以添加到所有的通过Agent传输的<code>spans</code>中.通过命令行参数<code>--jaeger.tags=key1=value1,key2=value2,...,keyn=valuen</code>,也可以通过环境变量<code>--jaeger.tags=key=${envFlag:defaultValue}</code>,标签值将会被设置为<code>envFlag</code>环境变量的值,如没有设置,则标签值默认设置为<code>defaultValue</code>.</p>
<h3 id="收集器">收集器</h3>
<p>Collector是无状态的且可以并行的运行多个<code>jaeger-collector</code>实例.Collector大部分是不需要配置的,除了使用Cassandra集群时的<code>--cassandra.keyspace</code>和<code>--cassandra.servers</code>选项,或则使用Elasticsearch集群时的<code>--es.server-urls</code>选项,依赖于特定的存储.用如下命令查看所有命令行选项<code>go run ./cmd/collector/main.go -h</code>,或则没有源码时使用如下命令<code>docker run -it --rm jaegertracing/jaeger-collector:1.21 -h</code>.</p>
<p>Collector默认暴露的端口号:</p>
<table>
<thead>
<tr>
<th style="text-align:left">端口号</th>
<th style="text-align:left">协议</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">14250</td>
<td style="text-align:left">gRPC</td>
<td style="text-align:left"><code>jaeger-agent</code>使用,用来发送model.proto格式的span到Collector</td>
</tr>
<tr>
<td style="text-align:left">14268</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">可以直接从客户端接受二进制的thrift协议的数据</td>
</tr>
<tr>
<td style="text-align:left">9411</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">可以接受Zipkin的span数据,支持Thrift,JSON和Proto(默认是禁用)</td>
</tr>
<tr>
<td style="text-align:left">14269</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">管理端口:在<code>/</code>的健康检查和在<code>/metrics</code>的指标</td>
</tr>
</tbody>
</table>
<h3 id="后端存储">后端存储</h3>
<p>Collector需要一个支持持久化的后端存储,Cassandra和ElasticSearch是主要支持的存储后端,其它后端可参考<a href="https://github.com/jaegertracing/jaeger/issues/638" target="_blank" rel="noopener noreffer">这里</a>.</p>
<p>存储类型是根据环境变量<code>SPAN_STORAGE_TYPE</code>来的,其值可以为<code>cassandra</code>,<code>elasticsearch</code>,<code>kafka</code>(仅用于缓存),<code>grpc-plugin</code>,<code>badger</code>(仅用于all-in-one)和<code>memory</code>(仅用于all-in-one).</p>
<p>在版本1.6.0之后,通过向环境变量<code>SPAN_STORAGE_TYPE</code>提供以逗号分隔的多个有效类型列表,可以同时使用多个存储类型.存储列表对应的所有存储都会写入,但只有列表第一个类型对应的存储负责提供读和归档.</p>
<p>对于大规模生产部署,Jaeger团队<a href="https://www.jaegertracing.io/docs/1.21/faq/#what-is-the-recommended-storage-backend" target="_blank" rel="noopener noreffer">推荐Elasticsearch后端超过Cassandra</a>.</p>
<h4 id="memory">Memory</h4>
<p>in-memory存储不是为了生产环境准备的,主要是为了快速搭建环境而使用,当程序终止时数据将丢失,不具备持久化功能.</p>
<p>默认情况下,在内存中是不会限制trace的数量的,但也可以通过参数<code>--memory.max-traces</code>来设置.</p>
<h4 id="badger---本地存储">Badger - 本地存储</h4>
<p>1.9版本之后的实验性功能.</p>
<p><a href="https://github.com/dgraph-io/badger" target="_blank" rel="noopener noreffer">Badger</a>是嵌入式本地存储器,只适用于<code>all-in-one</code>发行版.默认情况下,它充当临时存储,使用临时文件系统.这些文件可以通过参数<code>--badger.ephemeral=false</code>来重写.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker run <span class="se">\
</span><span class="se"></span>  -e <span class="nv">SPAN_STORAGE_TYPE</span><span class="o">=</span>badger <span class="se">\
</span><span class="se"></span>  -e <span class="nv">BADGER_EPHEMERAL</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>  -e <span class="nv">BADGER_DIRECTORY_VALUE</span><span class="o">=</span>/badger/data <span class="se">\
</span><span class="se"></span>  -e <span class="nv">BADGER_DIRECTORY_KEY</span><span class="o">=</span>/badger/key <span class="se">\
</span><span class="se"></span>  -v &lt;storage_dir_on_host&gt;:/badger <span class="se">\
</span><span class="se"></span>  -p 16686:16686 <span class="se">\
</span><span class="se"></span>  jaegertracing/all-in-one:1.21
</code></pre></td></tr></table>
</div>
</div><h4 id="cassandra">Cassandra</h4>
<p>支持版本为3.4+.部署Cassandra可参考文档<a href="https://cassandra.apache.org/doc/latest/" target="_blank" rel="noopener noreffer">Apache Cassandra Docs</a>.</p>
<p><strong>配置</strong></p>
<ul>
<li>最简化命令:<code>docker run -e SPAN_STORAGE_TYPE=cassandra -e CASSANDRA_SERVERS=&lt;...&gt; jaegertracing/jaeger-collector:1.21</code></li>
<li>所有选项,通过如下命令可查看所有配置选项:<code>docker run -e SPAN_STORAGE_TYPE=cassandra jaegertracing/jaeger-collector:1.21 --help</code></li>
</ul>
<p><strong>Schema脚本</strong></p>
<p>提供了一个使用Cassandra的交互式shell<code>cqlsh</code>来初始化Cassandra的keyspace和schema的脚本:<code>MODE=test sh ./plugin/storage/cassandra/schema/create.sh | cqlsh</code></p>
<p>在生产环境下,传递<code>MODE=prod DATACENTER={datacenter}</code>参数给该脚本,其中<code>{datacenter}</code>是Cassandra配置/网络拓扑中使用的名称.</p>
<p>该脚本允许覆盖TTL,keyspace名称,复制因子等.运行不带参数的脚本,可查看可识别参数的完整列表.</p>
<p><strong>TLS支持</strong></p>
<p>Jaeger支持在客户端与所配置的Cassandra集群之间采用TLS连接.在例如<code>cqlsh</code>的验证之后,可使用如下命令配置Collector:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker run <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_SERVERS</span><span class="o">=</span>&lt;...&gt; <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_TLS</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_TLS_SERVER_NAME</span><span class="o">=</span><span class="s2">&#34;CN-in-certificate&#34;</span> <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_TLS_KEY</span><span class="o">=</span>&lt;path to client key file&gt; <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_TLS_CERT</span><span class="o">=</span>&lt;path to client cert file&gt; <span class="se">\
</span><span class="se"></span>  -e <span class="nv">CASSANDRA_TLS_CA</span><span class="o">=</span>&lt;path to your CA cert file&gt; <span class="se">\
</span><span class="se"></span>  jaegertracing/jaeger-collector:1.21
</code></pre></td></tr></table>
</div>
</div><p>schema工具也支持TLS,可以使用如下自定义的cqlshrc文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Creating schema in a cassandra cluster requiring client TLS certificates.</span>
<span class="c1">#</span>
<span class="c1"># Create a volume for the schema docker container containing four files:</span>
<span class="c1"># cqlshrc: this file</span>
<span class="c1"># ca-cert: the cert authority for your keys</span>
<span class="c1"># client-key: the keyfile for your client</span>
<span class="c1"># client-cert: the cert file matching client-key</span>
<span class="c1">#</span>
<span class="c1"># if there is any sort of DNS mismatch and you want to ignore server validation</span>
<span class="c1"># issues, then uncomment validate = false below.</span>
<span class="c1">#</span>
<span class="c1"># When running the container, map this volume to /root/.cassandra and set the</span>
<span class="c1"># environment variable CQLSH_SSL=--ssl</span>
<span class="o">[</span>ssl<span class="o">]</span>
<span class="nv">certfile</span> <span class="o">=</span> ~/.cassandra/ca-cert
<span class="nv">userkey</span> <span class="o">=</span> ~/.cassandra/client-key
<span class="nv">usercert</span> <span class="o">=</span> ~/.cassandra/client-cert
<span class="c1"># validate = false</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="elasticsearch">Elasticsearch</h4>
<p>从Jaeger0.6版本之后开始支持,支持5.x,6.x,7.x版本的Elasticsearch.</p>
<p>Elasticsearch版本会自动从根/ping端点检索.基于这些版本Jaeger使用兼容的索引映射和Elasticsearch REST API.版本可以通过参数<code>--es.version=</code>来指定.</p>
<p>除了安装和运行Elasticsearch外,Elasticsearch不需要初始化.一旦运行之后,会将正确的配置值传递给Jaeger收集器和查询服务.</p>
<p><strong>配置</strong></p>
<ul>
<li>最简化命令:<code>docker run -e SPAN_STORAGE_TYPE=elasticsearch -e ES_SERVER_URLS=&lt;...&gt; jaegertracing/jaeger-collector:1.21</code></li>
<li>所有选项,通过如下命令可查看所有配置选项:<code>docker run -e SPAN_STORAGE_TYPE=elasticsearch jaegertracing/jaeger-collector:1.21 --help</code></li>
</ul>
<p><strong>Elasticsearch索引的分片和副本</strong></p>
<p>分片和副本有些配置值是需要特别关注的,因为这些会决定索引的创建.<a href="https://qbox.io/blog/optimizing-elasticsearch-how-many-shards-per-index" target="_blank" rel="noopener noreffer">这篇文章</a>将详细介绍如何选择多少个分片在优化时.</p>
<h4 id="kafka">Kafka</h4>
<p>从Jaeger1.6.0版本之后开始支持,支持0.9+版本的Kafka.</p>
<p>Kafka主要是作为收集器和真实的存储之间的临时缓存.收集器被配置为<code>SPAN_STORAGE_TYPE=kafka</code>,使得收集器上接收到的所有spans会被写入到一个Kafka的topic中.在1.7.0版本新增的一个组件<a href="https://www.jaegertracing.io/docs/1.21/deployment/#ingester" target="_blank" rel="noopener noreffer">Ingester</a>,用来从Kafka中读取然后存储spans到另一个存储后端(如Elasticsearch或Cassandra).</p>
<p>写入Kafka对于构建后处理数据管道特别有用.</p>
<p><strong>配置</strong></p>
<ul>
<li>最简化命令:<code>docker run -e SPAN_STORAGE_TYPE=kafka -e KAFKA_PRODUCER_BROKERS=&lt;...&gt; -e KAFKA_TOPIC=&lt;...&gt; jaegertracing/jaeger-collector:1.21</code></li>
<li>所有选项,通过如下命令可查看所有配置选项:<code>docker run -e SPAN_STORAGE_TYPE=kafka jaegertracing/jaeger-collector:1.21 --help</code></li>
</ul>
<p><strong>Topic和分区</strong></p>
<p>除非Kafka集群被配置为自动创建topic,否则应该提前创建好topic.可以参考<a href="https://kafka.apache.org/documentation/#quickstart_createtopic" target="_blank" rel="noopener noreffer">Kafka快速入门文档</a>来了解如何做到这一点.</p>
<p>在<a href="https://kafka.apache.org/documentation/#intro_topics" target="_blank" rel="noopener noreffer">官方文档</a>可了解到更多关于topic和分区的信息.<a href="https://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/" target="_blank" rel="noopener noreffer">这篇文章</a>关于如何选择分区的数量有更多的细节.</p>
<h4 id="存储插件">存储插件</h4>
<p>Jaeger支持基于gRPC协议的存储插件.更多细节参考<a href="https://www.confluent.io/blog/how-to-choose-the-number-of-topicspartitions-in-a-kafka-cluster/" target="_blank" rel="noopener noreffer">jaeger/plugin/storage/grpc</a></p>
<p>当前可用插件:</p>
<ul>
<li><a href="https://github.com/influxdata/jaeger-influxdb/" target="_blank" rel="noopener noreffer">InfluxDB</a></li>
<li><a href="https://github.com/logzio/jaeger-logzio" target="_blank" rel="noopener noreffer">Logz.io</a>,安全,可扩展,可管理,基于云的ELK存储.</li>
</ul>
<p>使用如下命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker run <span class="se">\
</span><span class="se"></span>  -e <span class="nv">SPAN_STORAGE_TYPE</span><span class="o">=</span>grpc-plugin <span class="se">\
</span><span class="se"></span>  -e <span class="nv">GRPC_STORAGE_PLUGIN_BINARY</span><span class="o">=</span>&lt;...&gt; <span class="se">\
</span><span class="se"></span>  -e <span class="nv">GRPC_STORAGE_PLUGIN_CONFIGURATION_FILE</span><span class="o">=</span>&lt;...&gt; <span class="se">\
</span><span class="se"></span>  jaegertracing/all-in-one:1.21
</code></pre></td></tr></table>
</div>
</div><h3 id="ingester-1">Ingester</h3>
<p><code>jaeger-ingester</code>是一个服务用来从Kafka的topic中读取spans数据,然后写入到另一个后端存储中(Elasticsearch或Cassandra).</p>
<table>
<thead>
<tr>
<th style="text-align:left">端口号</th>
<th style="text-align:left">协议</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">14270</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">管理端口:在<code>/</code>端点的健康检查和在<code>/metrics</code>的指标</td>
</tr>
</tbody>
</table>
<p>使用如下命令查看所有配置选项:<code>docker run -e SPAN_STORAGE_TYPE=cassandra jaegertracing/jaeger-ingester:1.21 --help</code></p>
<h3 id="query-service--ui">Query Service &amp; UI</h3>
<p><code>jaeger-query</code>服务提供API和一个React/Javascript的UI.服务是无状态的,经常是运行在负载均衡器之后,如<a href="https://www.nginx.com/" target="_blank" rel="noopener noreffer">NGINX</a>.</p>
<p>有如下端口会暴露:</p>
<table>
<thead>
<tr>
<th style="text-align:left">端口号</th>
<th style="text-align:left">协议</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">16686</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left"><code>/api/*</code>端点,UI在<code>/</code></td>
</tr>
<tr>
<td style="text-align:left">16686</td>
<td style="text-align:left">gRPC</td>
<td style="text-align:left">Protobuf/gRPC <a href="https://github.com/jaegertracing/jaeger-idl/blob/master/proto/api_v2/query.proto" target="_blank" rel="noopener noreffer">查询服务</a></td>
</tr>
<tr>
<td style="text-align:left">16687</td>
<td style="text-align:left">HTTP</td>
<td style="text-align:left">管理端口:在<code>/</code>端点的健康检查和在<code>/metrics</code>的指标</td>
</tr>
</tbody>
</table>
<p><strong>最小依赖例子(Elasticsearch为后端存储):</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">docker run -d --rm <span class="se">\
</span><span class="se"></span>  -p 16686:16686 <span class="se">\
</span><span class="se"></span>  -p 16687:16687 <span class="se">\
</span><span class="se"></span>  -e <span class="nv">SPAN_STORAGE_TYPE</span><span class="o">=</span>elasticsearch <span class="se">\
</span><span class="se"></span>  -e <span class="nv">ES_SERVER_URLS</span><span class="o">=</span>http://&lt;ES_SERVER_IP&gt;:&lt;ES_SERVER_PORT&gt; <span class="se">\
</span><span class="se"></span>  jaegertracing/jaeger-query:1.21
</code></pre></td></tr></table>
</div>
</div><p><strong>时钟偏移调整</strong></p>
<p>Jaeger后端会聚合来自不同主机的应用程序的追踪数据.主机上的硬件时钟经常会经历相对漂移,称为<a href="https://en.wikipedia.org/wiki/Clock_skew" target="_blank" rel="noopener noreffer">时钟偏移效应</a>.时钟偏移会使得追踪数据的推断变得困难,假如,当一个服务的span有可能比客户端的span更早产生,这种情况是不可能的.查询服务实现了一个时钟偏移调整的<a href="https://github.com/jaegertracing/jaeger/blob/master/model/adjuster/clockskew.go" target="_blank" rel="noopener noreffer">算法</a>,使用span之间的因果关系知识来校正时钟偏移.所有被调整的span在UI上会显示一个告警信息,提供应用其时间戳的精确时钟偏移增量.</p>
<p>有时这些调整本身使得追踪难以理解.例如,当在父span的范围内重新定位服务span时,Jaeger不知道请求和响应延迟之间的确切关系,因此假设两者相等,并将子span放在父span的中间(参见<a href="https://github.com/jaegertracing/jaeger/issues/961#issuecomment-453925244" target="_blank" rel="noopener noreffer">issue #961</a>).</p>
<p>查询服务支持一个配置选项<code>--query.max-clock-skew-adjustment</code>,用来控制多少时钟偏移调整是被允许的.如果该参数被设置为zero(0s)则会完全禁用时钟偏移调整.此设置适用于从给定查询服务检索的所有追踪.有一个开放<a href="https://github.com/jaegertracing/jaeger-ui/issues/197" target="_blank" rel="noopener noreffer">标签#197</a>来支持在UI中直接切换调整的开启和关闭.</p>
<p><strong>UI基础Path</strong></p>
<p>针对所有<code>jaeger-query</code>的HTTP路由的基础路径可以设置为一个非root的值,如<code>/jaeger</code>,会导致所有UI URLs会已<code>/jaeger</code>开头.当在反向代理后运行的<code>jaeger-query</code>是非常有用的.</p>
<p>可以通过命令行参数<code>--query.base-path</code>或环境变量<code>QUERY_BASE_PATH</code>来配置基础路径.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-12-14</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/opentracing-jaeger-guide/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://shenbaise9527.com/opentracing-jaeger-guide/" data-title="Jaeger指南" data-via="shenbaise9527" data-hashtags="OpenTracing"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://shenbaise9527.com/opentracing-jaeger-guide/" data-hashtag="OpenTracing"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://shenbaise9527.com/opentracing-jaeger-guide/" data-title="Jaeger指南"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/opentracing/">OpenTracing</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/opentracing-zipkin-guide/" class="prev" rel="prev" title="Zipkin指南"><i class="fas fa-angle-left fa-fw"></i>Zipkin指南</a>
            <a href="/opentracing-jaeger-action/" class="next" rel="next" title="Jaeger实战">Jaeger实战<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://shenbaise9527.com" target="_blank">深白色</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":100},"comment":{},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-R1HW7DNZ94', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-R1HW7DNZ94" async></script></body>
</html>
